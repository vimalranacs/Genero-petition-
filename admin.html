<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Student Voice</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
        }

        .admin-header {
            background: #0f172a;
            color: #fff;
            padding: 20px;
            text-align: center;
        }

        .admin-header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .admin-header p {
            font-size: 0.82rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .login-box {
            max-width: 400px;
            margin: 60px auto;
            text-align: center;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 40px 32px;
        }

        .login-box h2 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .login-box p {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 24px;
        }

        .btn-google {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-google:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 16px;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .admin-bar .user-info {
            font-size: 0.85rem;
            color: #64748b;
        }

        .admin-bar .user-info strong {
            color: #1e293b;
        }

        .btn-logout {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: #fee2e2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-box .num {
            font-size: 1.6rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            background: none;
            border: none;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 0.88rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab:hover {
            color: #1e293b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .action-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn-add {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #2563eb;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 28px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal h3 {
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .modal input,
        .modal select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .modal input:focus,
        .modal select:focus {
            border-color: #3b82f6;
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .btn-save {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #2563eb;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #f1f5f9;
            text-align: left;
            padding: 10px 12px;
            font-size: 0.72rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 10px 12px;
            font-size: 0.82rem;
            border-top: 1px solid #f1f5f9;
        }

        tr:hover td {
            background: #fafbfc;
        }

        .btn-delete {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-delete:hover {
            background: #fee2e2;
        }

        .btn-edit {
            background: #eff6ff;
            color: #3b82f6;
            border: 1px solid #dbeafe;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            margin-right: 4px;
        }

        .btn-edit:hover {
            background: #dbeafe;
        }

        .back-link {
            display: inline-block;
            margin-top: 24px;
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.85rem;
        }

        @media (max-width: 640px) {

            th,
            td {
                padding: 8px 6px;
                font-size: 0.72rem;
            }

            .btn-edit,
            .btn-delete {
                padding: 3px 6px;
                font-size: 0.65rem;
            }
        }
    </style>
</head>

<body>

    <div class="admin-header">
        <h1>üîí Admin Panel</h1>
        <p>Manage signatures and comments</p>
    </div>

    <div class="login-box" id="loginBox">
        <h2>Admin Access</h2>
        <p>Sign in with your authorized Google account to manage entries.</p>
        <button class="btn-google" onclick="googleLogin()">
            <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#4285F4"
                    d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" />
                <path fill="#34A853"
                    d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" />
                <path fill="#FBBC05"
                    d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" />
                <path fill="#EA4335"
                    d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" />
            </svg>
            Sign in with Google
        </button>
        <p class="error-msg" id="loginError"></p>
    </div>

    <div class="container admin-panel" id="adminPanel">
        <div class="admin-bar">
            <div class="user-info">Logged in as <strong id="userName"></strong></div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('signatures', this)">Signatures</button>
            <button class="tab" onclick="switchTab('comments', this)">Comments</button>
        </div>

        <div class="tab-content active" id="signaturesTab">
            <div class="action-bar">
                <button class="btn-add" onclick="openAddSignature()">+ Add Signature</button>
            </div>
            <div id="sigTable"></div>
        </div>

        <div class="tab-content" id="commentsTab">
            <div class="action-bar">
                <button class="btn-add" onclick="openAddComment()">+ Add Comment</button>
            </div>
            <div id="comTable"></div>
        </div>

        <a href="index.html" class="back-link">‚Üê Back to Petition</a>
    </div>

    <!-- ADD/EDIT SIGNATURE MODAL -->
    <div class="modal-overlay" id="sigModal">
        <div class="modal">
            <h3 id="sigModalTitle">Add Signature</h3>
            <input type="hidden" id="editSigId">
            <input id="mName" placeholder="Full Name" required>
            <input id="mRoll" placeholder="Roll Number" required>
            <select id="mCourse">
                <option value="">Select Course</option>
                <option value="B.Tech">B.Tech</option>
                <option value="BCA">BCA</option>
                <option value="MBA">MBA</option>
                <option value="MCA">MCA</option>
            </select>
            <input id="mBranch" placeholder="Branch (e.g. CSE)">
            <select id="mYear">
                <option value="">Select Year</option>
                <option value="1st Year">1st Year</option>
                <option value="2nd Year">2nd Year</option>
                <option value="3rd Year">3rd Year</option>
                <option value="4th Year">4th Year</option>
            </select>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('sigModal')">Cancel</button>
                <button class="btn-save" onclick="saveSignature()">Save</button>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT COMMENT MODAL -->
    <div class="modal-overlay" id="comModal">
        <div class="modal">
            <h3 id="comModalTitle">Add Comment</h3>
            <input type="hidden" id="editComId">
            <textarea id="mComText" placeholder="Comment text..." rows="3"
                style="width:100%;padding:10px 12px;margin-bottom:10px;border:1px solid #e2e8f0;border-radius:6px;font-family:inherit;font-size:0.85rem;resize:vertical"></textarea>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('comModal')">Cancel</button>
                <button class="btn-save" onclick="saveComment()">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_EMAIL = "vimalrana877@gmail.com";

        // ===== AUTH =====
        window.googleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                if (result.user.email !== ADMIN_EMAIL) {
                    document.getElementById("loginError").textContent = "Access denied. This account is not authorized.";
                    await signOut(auth);
                    return;
                }
                showAdmin(result.user);
            } catch (err) {
                console.error("Login error:", err);
                document.getElementById("loginError").textContent = "Login failed: " + err.message;
            }
        };

        window.logout = async () => {
            await signOut(auth);
            document.getElementById("adminPanel").classList.remove("active");
            document.getElementById("loginBox").style.display = "block";
        };

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) showAdmin(user);
        });

        function showAdmin(user) {
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("adminPanel").classList.add("active");
            document.getElementById("userName").textContent = user.email;
            loadAdminData();
        }

        // ===== TABS =====
        window.switchTab = (tab, el) => {
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
            el.classList.add("active");
            document.getElementById(tab + "Tab").classList.add("active");
        };

        // ===== MODALS =====
        window.closeModal = (id) => {
            document.getElementById(id).classList.remove("active");
        };

        window.openAddSignature = () => {
            document.getElementById("sigModalTitle").textContent = "Add Signature";
            document.getElementById("editSigId").value = "";
            document.getElementById("mName").value = "";
            document.getElementById("mRoll").value = "";
            document.getElementById("mCourse").value = "";
            document.getElementById("mBranch").value = "";
            document.getElementById("mYear").value = "";
            document.getElementById("sigModal").classList.add("active");
        };

        window.openEditSignature = (id, name, roll, course, branch, year) => {
            document.getElementById("sigModalTitle").textContent = "Edit Signature";
            document.getElementById("editSigId").value = id;
            document.getElementById("mName").value = name;
            document.getElementById("mRoll").value = roll;
            document.getElementById("mCourse").value = course;
            document.getElementById("mBranch").value = branch;
            document.getElementById("mYear").value = year;
            document.getElementById("sigModal").classList.add("active");
        };

        window.openAddComment = () => {
            document.getElementById("comModalTitle").textContent = "Add Comment";
            document.getElementById("editComId").value = "";
            document.getElementById("mComText").value = "";
            document.getElementById("comModal").classList.add("active");
        };

        window.openEditComment = (id, text) => {
            document.getElementById("comModalTitle").textContent = "Edit Comment";
            document.getElementById("editComId").value = id;
            document.getElementById("mComText").value = text;
            document.getElementById("comModal").classList.add("active");
        };

        // ===== SAVE =====
        window.saveSignature = async () => {
            const id = document.getElementById("editSigId").value;
            const data = {
                name: document.getElementById("mName").value.trim(),
                roll: document.getElementById("mRoll").value.trim(),
                course: document.getElementById("mCourse").value,
                branch: document.getElementById("mBranch").value.trim().toUpperCase(),
                year: document.getElementById("mYear").value
            };

            if (!data.name || !data.roll) { alert("Name and Roll are required."); return; }

            try {
                if (id) {
                    await updateDoc(doc(db, "signatures", id), data);
                } else {
                    data.timestamp = Date.now();
                    await addDoc(collection(db, "signatures"), data);
                }
                closeModal("sigModal");
                loadAdminData();
            } catch (err) {
                console.error("Save error:", err);
                alert("Save failed: " + err.message);
            }
        };

        window.saveComment = async () => {
            const id = document.getElementById("editComId").value;
            const text = document.getElementById("mComText").value.trim();

            if (!text) { alert("Comment text is required."); return; }

            try {
                if (id) {
                    await updateDoc(doc(db, "comments", id), { text });
                } else {
                    await addDoc(collection(db, "comments"), { text, time: Date.now(), likes: 0 });
                }
                closeModal("comModal");
                loadAdminData();
            } catch (err) {
                console.error("Save error:", err);
                alert("Save failed: " + err.message);
            }
        };

        // ===== LOAD DATA =====
        async function loadAdminData() {
            try {
                const sigSnap = await getDocs(collection(db, "signatures"));
                const sigs = [];
                sigSnap.forEach(d => sigs.push({ ...d.data(), id: d.id }));
                sigs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                const comSnap = await getDocs(collection(db, "comments"));
                const coms = [];
                comSnap.forEach(d => coms.push({ ...d.data(), id: d.id }));
                coms.sort((a, b) => (b.time || 0) - (a.time || 0));

                // Stats
                document.getElementById("statsGrid").innerHTML = `
            <div class="stat-box"><div class="num">${sigs.length}</div><div class="label">Signatures</div></div>
            <div class="stat-box"><div class="num">${coms.length}</div><div class="label">Comments</div></div>
            <div class="stat-box"><div class="num">${new Set(sigs.map(s => (s.branch || '').toUpperCase())).size}</div><div class="label">Branches</div></div>
            <div class="stat-box"><div class="num">${new Set(sigs.map(s => s.course || '')).size}</div><div class="label">Courses</div></div>
        `;

                // Signatures table
                const sigTable = document.getElementById("sigTable");
                if (sigs.length === 0) {
                    sigTable.innerHTML = '<p style="color:#94a3b8;padding:20px">No signatures.</p>';
                } else {
                    let html = `<table><thead><tr><th>Name</th><th>Roll</th><th>Course</th><th>Branch</th><th>Year</th><th>Actions</th></tr></thead><tbody>`;
                    sigs.forEach(s => {
                        const eName = esc(s.name);
                        const eRoll = esc(s.roll);
                        const eCourse = esc(s.course);
                        const eBranch = esc(s.branch);
                        const eYear = esc(s.year);
                        html += `<tr>
                    <td>${eName}</td>
                    <td>${eRoll}</td>
                    <td>${eCourse}</td>
                    <td>${eBranch}</td>
                    <td>${eYear}</td>
                    <td>
                        <button class="btn-edit" onclick="openEditSignature('${s.id}','${eName}','${eRoll}','${eCourse}','${eBranch}','${eYear}')">Edit</button>
                        <button class="btn-delete" onclick="deleteEntry('signatures','${s.id}')">Delete</button>
                    </td>
                </tr>`;
                    });
                    html += '</tbody></table>';
                    sigTable.innerHTML = html;
                }

                // Comments table
                const comTable = document.getElementById("comTable");
                if (coms.length === 0) {
                    comTable.innerHTML = '<p style="color:#94a3b8;padding:20px">No comments.</p>';
                } else {
                    let html = `<table><thead><tr><th>Comment</th><th>Likes</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                    coms.forEach(c => {
                        const date = c.time ? new Date(c.time).toLocaleDateString("en-IN") : "";
                        const safeText = esc(c.text).replace(/'/g, "\\'");
                        html += `<tr>
                    <td style="max-width:350px">${esc(c.text)}</td>
                    <td>${c.likes || 0}</td>
                    <td>${date}</td>
                    <td>
                        <button class="btn-edit" onclick="openEditComment('${c.id}','${safeText}')">Edit</button>
                        <button class="btn-delete" onclick="deleteEntry('comments','${c.id}')">Delete</button>
                    </td>
                </tr>`;
                    });
                    html += '</tbody></table>';
                    comTable.innerHTML = html;
                }

            } catch (err) {
                console.error("Admin load error:", err);
            }
        }

        // ===== DELETE =====
        window.deleteEntry = async (collName, docId) => {
            if (!confirm("Are you sure you want to delete this entry?")) return;
            try {
                await deleteDoc(doc(db, collName, docId));
                loadAdminData();
            } catch (err) {
                console.error("Delete error:", err);
                alert("Delete failed: " + err.message);
            }
        };

        function esc(str) {
            const div = document.createElement("div");
            div.textContent = str || "";
            return div.innerHTML;
        }
    </script>

</body>

</html>